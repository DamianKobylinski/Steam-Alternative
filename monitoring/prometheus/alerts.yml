groups:
  - name: database_alerts
    rules:
      # Alert when database queries are failing
      - alert: DatabaseQueryFailures
        expr: increase(database_query_failures_total[5m]) >= 20
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Database query failures detected"
          description: "More than 20 database query failures detected in the last 5 minutes. Current failure count: {{ $value }}"
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"

      # Alert when database is completely unreachable
      - alert: DatabaseUnreachable
        expr: database_connection_status == 0
        for: 30s
        labels:
          severity: critical
        annotations:
          summary: "Database is unreachable"
          description: "The database connection has been down for more than 30 seconds"
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"

      # Alert when postgres exporter is down (backup alert)
      - alert: PostgresExporterDown
        expr: up{job="postgresql"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL exporter is down"
          description: "PostgreSQL exporter has been unreachable for more than 1 minute. Database monitoring is unavailable."
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"

      # Alert when database query latency is high
      - alert: DatabaseHighLatency
        expr: histogram_quantile(0.95, rate(database_query_duration_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database queries are slow"
          description: "95th percentile of database query duration is above 1 second"
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"

  - name: application_alerts
    rules:
      # Alert when Next.js app is down
      - alert: NextJsAppDown
        expr: up{job="nextjs-app"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Next.js application is down"
          description: "The Next.js application has been unreachable for more than 1 minute"
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"

      # Alert when Photos service is down
      - alert: PhotosServiceDown
        expr: up{job="photos-service"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Photos service is down"
          description: "The Photos service has been unreachable for more than 1 minute"
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"

      # Alert on high error rate
      - alert: HighErrorRate
        expr: sum(rate(http_requests_total{status_code=~"5.."}[5m])) / sum(rate(http_requests_total[5m])) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High HTTP error rate"
          description: "More than 10% of requests are resulting in 5xx errors"
          time: "{{ with query \"time()\" }}{{ . | first | value | humanizeTimestamp }}{{ end }}"
