services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      network: host
      args:
        DATABASE_URL: ${DATABASE_URL}
        STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
        NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
        CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
    restart: unless-stopped
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://postgres:SteamAlternative@localhost:5433/steam_alternative?schema=public
      PHOTOS_BASE_URL: http://localhost:8000
    network_mode: host
    depends_on:
      postgres_service:
        condition: service_healthy
      photos_service:
        condition: service_started

  photos_service:
    build:
      context: ./photos_server
      dockerfile: Dockerfile
      network: host
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./photos_server/photos:/photos_server/photos:ro

  postgres_service:
    image: postgres:18
    restart: unless-stopped
    env_file:
      - .env
    network_mode: host
    volumes:
      - pg-data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -p 5433"]
      interval: 5s
      timeout: 5s
      retries: 5
    command: -p 5433

  pgadmin_service:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    env_file:
      - .env
    network_mode: host
    user: root
    depends_on:
      postgres_service:
        condition: service_healthy
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    environment:
      PGADMIN_LISTEN_PORT: 15432

  # Prometheus metrics server
  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - ./monitoring/prometheus/recording_rules.yml:/etc/prometheus/recording_rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/etc/prometheus/console_libraries"
      - "--web.console.templates=/etc/prometheus/consoles"
      - "--web.enable-lifecycle"
      - "--web.listen-address=:9090"

  # Alertmanager for email alerts
  alertmanager:
    image: prom/alertmanager:latest
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - ./monitoring/alertmanager/templates:/etc/alertmanager/templates:ro
      - alertmanager-data:/alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
      - "--web.listen-address=:9093"
    env_file:
      - .env

  # Grafana dashboard
  grafana:
    image: grafana/grafana:latest
    restart: unless-stopped
    network_mode: host
    environment:
      GF_SERVER_HTTP_PORT: 3001
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus

  # PostgreSQL exporter for database metrics
  postgres_exporter:
    image: prometheuscommunity/postgres-exporter:latest
    restart: unless-stopped
    network_mode: host
    environment:
      DATA_SOURCE_NAME: "postgresql://postgres:SteamAlternative@localhost:5433/steam_alternative?sslmode=disable"
    depends_on:
      postgres_service:
        condition: service_healthy

  # Uptime Kuma - Service status monitoring
  uptime_kuma:
    image: louislam/uptime-kuma:1
    restart: unless-stopped
    network_mode: host
    volumes:
      - uptime-kuma-data:/app/data
    environment:
      UPTIME_KUMA_PORT: 3002

  # Caddy reverse proxy with automatic SSL
  caddy:
    image: caddy:2-alpine
    restart: unless-stopped
    network_mode: host
    environment:
      DOMAIN: ${DOMAIN}
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config

volumes:
  pg-data:
  pgadmin-data:
  pgadmin-sessions:
  prometheus-data:
  alertmanager-data:
  grafana-data:
  uptime-kuma-data:
  caddy-data:
  caddy-config:
